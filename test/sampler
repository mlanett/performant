#!/usr/bin/env ruby

require "optparse"
require "ostruct"
require "performant"

my = OpenStruct.new env: "development", cfg: File.expand_path( "../example.yml", __FILE__ ), jobs: [ "stress", "fake" ]
Performant::Configuration.load! src: my.cfg, env: my.env

sampler     = Performant.sampler
sec_samples = Hash.new { { jobs: 0, busy: 0, work: 0 } }

sampler.loop_until_false do

  puts Time.now
  my.jobs.each do |job|

    storage     = Performant.storage(job)
    last_sample = sec_samples[job]
    now_sample  = storage.uninterruptedly { storage.tick! }
    diff        = sampler.diff( now_sample, last_sample )
    puts diff.merge( job: job ).inspect

    sec_samples[job] = now_sample
  end
  true
end
